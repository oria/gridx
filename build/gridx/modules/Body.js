//>>built
define("gridx/modules/Body","dojo/_base/declare gridx/support/query dojo/_base/array dojo/_base/lang dojo/_base/json dojo/dom-construct dojo/dom-class dojo/_base/Deferred dojo/_base/sniff dojo/keys ../core/_Module".split(" "),function(A,q,r,y,z,u,n,v,w,x,B){return A(B,{name:"body",forced:["view"],constructor:function(){var a=this,b=a.grid,d=a.domNode=b.bodyNode;a._cellCls={};a.arg("rowHoverEffect")&&n.add(d,"gridxBodyRowHoverEffect");b.emptyNode.innerHTML=a.arg("loadingInfo",b.nls.loadingInfo);b._connectEvents(d,
"_onMouseEvent",a);a.aspect(a.model,"onDelete","_onDelete");a.aspect(a.model,"onSet","_onSet");b.touch||(a.aspect(b,"onRowMouseOver","_onRowMouseOver"),a.connect(b.mainNode,"onmouseleave",function(){q("\x3e .gridxRowOver",a.domNode).removeClass("gridxRowOver")}),a.connect(b.mainNode,"onmouseover",function(d){d.target==b.bodyNode&&q("\x3e .gridxRowOver",a.domNode).removeClass("gridxRowOver")}));a.aspect(b.model,"setStore",function(){a.refresh()})},preload:function(){this._initFocus()},load:function(a){a=
this.grid.view;this.aspect(a,"onUpdate","lazyRefresh");a._err&&this._loadFail(a._err);this.loaded.callback()},destroy:function(){this.inherited(arguments);this.domNode.innerHTML="";this._destroyed=!0},rowMixin:{node:function(){return this.grid.body.getRowNode({rowId:this.id})}},cellMixin:{node:function(){return this.grid.body.getCellNode({rowId:this.row.id,colId:this.column.id})},contentNode:function(){var a=this.node();return a&&q(".gridxCellContent",a)[0]||a}},rowHoverEffect:!0,stuffEmptyCell:!0,
renderWholeRowOnSet:!1,renderStart:0,renderCount:0,autoUpdate:!0,compareOnSet:function(a,b){return"object"==typeof a&&"object"==typeof b?z.toJson(a)==z.toJson(b):a===b},addClass:function(a,b,d){var e=this._cellCls,e=e[a]=e[a]||{},e=e[b]=e[b]||[];0>r.indexOf(e,d)&&(e.push(d),n.add(this.getCellNode({rowId:a,colId:b}),d))},removeClass:function(a,b,d){var e=this._cellCls[a],c=(e=e&&e[b])&&r.indexOf(e,d);0<=c&&(e.splice(c,1),n.remove(this.getCellNode({rowId:a,colId:b}),d))},getRowNode:function(a){return this.model.isId(a.rowId)&&
w("ie")?this._getRowNode(a.rowId):(a=this._getRowNodeQuery(a))&&q("\x3e "+a,this.domNode)[0]||null},getCellNode:function(a){var b=a.colId,d=this.grid._columns,e=this._getRowNodeQuery(a);return e?(!b&&d[a.colIndex]&&(b=d[a.colIndex].id),b=" [colid\x3d'"+b+"'].gridxCell",this.model.isId(a.rowId)&&w("ie")?(a=this._getRowNode(a.rowId))&&q(b,a)[0]||null:q(e+b,this.domNode)[0]||null):null},refresh:function(a){var b=this,d=b.grid.loadingNode,e=new v;delete b._err;clearTimeout(b._sizeChangeHandler);n.toggle(b.domNode,
"gridxBodyRowHoverEffect",b.arg("rowHoverEffect"));n.add(d,"gridxLoading");b.grid.view.updateVisualCount().then(function(){try{var c=b.renderStart,f=b.renderCount,g=b.grid.view.visualCount;c+f>g&&(f<g?c=b.renderStart=g-f:(c=b.renderStart=0,f=g));if("number"==typeof a&&0<=a){a=c>a?c:a;var l=c+f-a,k=q('\x3e [visualindex\x3d"'+a+'"]',b.domNode)[0],c=[],f=[];if(k){var h=b._buildRows(a,l,c,f);h&&u.place(h,k,"before")}var m={};for(r.forEach(f,function(a){m[a.id]=1});k;){var s=k.nextSibling,p=k.getAttribute("rowid");
if(!m[p])b.onUnrender(p,"refresh");u.destroy(k);k=s}r.forEach(f,b.onAfterRow,b);v.when(b._buildUncachedRows(c),function(){b.onRender(a,l);b.onForcedScroll();n.remove(d,"gridxLoading");e.callback()})}else b.renderRows(c,f,0,1),b.onForcedScroll(),n.remove(d,"gridxLoading"),e.callback()}catch(t){b._loadFail(t),n.remove(d,"gridxLoading"),e.errback(t)}},function(a){b._loadFail(a);n.remove(d,"gridxLoading");e.errback(a)});return e},refreshCell:function(a,b){var d=new v,e=this,c=e.model,f=e.grid,g=f._columns[b],
l=g&&e.getCellNode({visualIndex:a,colId:g.id});if(l){var k,h=f.view.getRowInfo({visualIndex:a}),m=h.rowIndex,s=h.parentId;c.when({start:m,count:1,parentId:s},function(){if(k=c.byIndex(m,s)){h.rowId=c.indexToId(m,s);var b=f.cell(h.rowId,g.id,1),d=f.tree&&f.tree.isPaddingCell(h.rowId,g.id);l.innerHTML=e._buildCellContent(g,h.rowId,b,a,d);e.onAfterCell(b)}}).then(function(){d.callback(!!k)});return d}d.callback(!1);return d},lazyRefresh:function(){var a=this;clearTimeout(a._sizeChangeHandler);a._sizeChangeHandler=
setTimeout(function(){a._destroyed||a.refresh()},10)},renderRows:function(a,b,d,e){var c=this,f=c.grid,g="",l=[],k=[],h=c.domNode,m=f.emptyNode,s=c.arg("emptyInfo",f.nls.emptyInfo),p="";if(!c._err)if(0<b){m.innerHTML=c.arg("loadingInfo",f.nls.loadingInfo);m.style.zIndex="";"top"!=d&&"bottom"!=d&&c.model.free();g=c._buildRows(a,b,l,k);if("top"==d)c.renderCount+=c.renderStart-a,c.renderStart=a,u.place(g,h,"first"),f.cellWidget&&f.vScroller._updateRowHeight&&(g=c.renderStart+c.renderCount,f=f.vScroller._updateRowHeight("post"),
g-f<a+b&&(b=g-f-a));else if("bottom"==d)c.renderCount=a+b-c.renderStart,u.place(g,h,"last"),f.cellWidget&&f.vScroller._updateRowHeight&&(f.vScroller._updateRowHeight("pre"),c.renderStart>a&&(a=c.renderStart,b=c.renderCount));else{c.renderStart=a;c.renderCount=b;d=e?h.scrollTop:0;if(!c._skipUnrender)c.onUnrender();h.innerHTML=g;h.scrollTop=d;h.scrollLeft=f.hScrollerNode.scrollLeft;p=g?"":s;g||(m.style.zIndex=1)}r.forEach(k,c.onAfterRow,c);v.when(c._buildUncachedRows(l),function(){c._err||(m.innerHTML=
p);c.onRender(a,b)})}else if(!{top:1,bottom:1}[d]){h.scrollTop=0;if(!c._skipUnrender)c.onUnrender();h.innerHTML="";m.innerHTML=s;m.style.zIndex="";c.onEmpty();c.model.free()}},unrenderRows:function(a,b){if(0<a){var d=this.model,e=0,c,f=this.domNode;if("post"==b)for(;e<a&&f.lastChild;++e)c=f.lastChild.getAttribute("rowid"),d.isId(c)&&(d.free(c),this.onUnrender(c)),u.destroy(f.lastChild);else{for(var g=f.scrollTop;e<a&&f.firstChild;++e){c=f.firstChild.getAttribute("rowid");var l=f.firstChild.getAttribute("data-rowHeight"),
g=g-(l?parseInt(l,10):f.firstChild.offsetHeight);d.isId(c)&&(d.free(c),this.onUnrender(c));u.destroy(f.firstChild)}this.renderStart+=e;f.scrollTop=0<g?g:0}this.renderCount-=e;d.when()}},onAfterRow:function(){},onAfterCell:function(){},onRender:function(){var a=this.domNode;9>w("ie")&&a.childNodes.length&&(q("\x3e gridxLastRow",a).removeClass("gridxLastRow"),n.add(a.lastChild,"gridxLastRow"))},onUnrender:function(){},onDelete:function(){},onSet:function(){},onMoveToCell:function(){},onEmpty:function(){},
onLoadFail:function(){},onForcedScroll:function(){},collectCellWrapper:function(){},_getRowNodeQuery:function(a){var b,d=this.model,e=this.grid._escapeId;d.isId(a.rowId)?b="[rowid\x3d'"+e(a.rowId)+"']":"number"==typeof a.rowIndex&&0<=a.rowIndex?b="[rowindex\x3d'"+a.rowIndex+"']"+(d.isId(a.parentId)?"[parentid\x3d'"+e(a.parentId)+"']":""):"number"==typeof a.visualIndex&&0<=a.visualIndex&&(b="[visualindex\x3d'"+a.visualIndex+"']");return b&&b+".gridxRow"},_getRowNode:function(a){for(var b=0,d=this.domNode.childNodes,
e;e=d[b];++b)if(e.getAttribute("rowid")==a)return e;return null},_loadFail:function(a){console.error(a);var b=this.grid.emptyNode;b.innerHTML=this.arg("loadFailInfo",this.grid.nls.loadFailInfo);b.style.zIndex=1;this.domNode.innerHTML="";this._err=a;this.onEmpty();this.onLoadFail(a)},_buildRows:function(a,b,d,e){b=a+b;for(var c=[],f=this.grid,g=this.domNode.scrollWidth,l=f.columns();a<b;++a){var k=f.view.getRowInfo({visualIndex:a}),h=f.row(k.rowId,1);c.push('\x3cdiv class\x3d"gridxRow ',a%2?"gridxRowOdd":
"",'" role\x3d"row" visualindex\x3d"',a);h?(this.model.keep(h.id),c.push('" rowid\x3d"',h.id,'" rowindex\x3d"',k.rowIndex,'" parentid\x3d"',k.parentId,'"\x3e',this._buildCells(h,a,l),"\x3c/div\x3e"),e.push(h)):(c.push('"\x3e\x3cdiv class\x3d"gridxRowDummy" style\x3d"width:',g,'px;"\x3e\x3c/div\x3e\x3c/div\x3e'),k.start=k.rowIndex,k.count=1,d.push(k))}return c.join("")},_buildUncachedRows:function(a){var b=this;return a.length&&b.model.when(a,function(){try{r.forEach(a,b._buildRowContent,b)}catch(d){b._loadFail(d)}}).then(null,
function(a){b._loadFail(a)})},_buildRowContent:function(a){var b=q('\x3e [visualindex\x3d"'+a.visualIndex+'"]',this.domNode)[0];if(b){var d=this.grid.row(a.rowIndex,0,a.parentId);d?(this.model.keep(d.id),b.setAttribute("rowid",d.id),b.setAttribute("rowindex",a.rowIndex),b.setAttribute("parentid",a.parentId||""),b.innerHTML=this._buildCells(d,a.visualIndex),this.onAfterRow(d)):console.error("Error in Body._buildRowContent: Row is not in cache: "+a.rowIndex)}},onCheckCustomRow:function(a,b){},onBuildCustomRow:function(a,
b){},_buildCells:function(a,b,d){var e=a.id,c=['\x3ctable class\x3d"gridxRowTable" role\x3d"presentation" border\x3d"0" cellpadding\x3d"0" cellspacing\x3d"0"\x3e\x3ctr\x3e'],f={};this.onCheckCustomRow(a,f);if(f[e])f={},this.onBuildCustomRow(a,f),c.push('\x3ctd class\x3d"gridxCustomRow" aria-readonly\x3d"true" role\x3d"gridcell" tabindex\x3d"-1"\x3e',this._wrapCellData(f[e],e),"\x3c/td\x3e");else for(var f=this.grid,g="body"==f.focus.currentArea()&&this._focusCellRow===b,l=this.model.byId(e).data,
k=f._columns,h=this._cellCls[e]||{},m=0,s=k.length;m<s;++m){var p=k[m],t=p.id,n=p.width,q=f.tree&&f.tree.isPaddingCell(e,t),r=p["class"],u=l[t],w=r&&y.isFunction(r),x=p.style&&y.isFunction(p.style),v=(w||x||!q&&p.decorator)&&f.cell(a,d&&d[m]||t,1);c.push('\x3ctd aria-readonly\x3d"true" role\x3d"gridcell" tabindex\x3d"-1" aria-describedby\x3d"',p._domId,'" colid\x3d"',t,'" class\x3d"gridxCell ',q?"gridxPaddingCell ":"",g&&this._focusCellCol===m?"gridxCellFocus ":"",p._class||""," ",(w?r(v):r)||"",
" ",h[t]?h[t].join(""):"",' " style\x3d"width:',n,";min-width:",n,";max-width:",n,";",f.getTextDirStyle(t,u),(x?p.style(v):p.style)||"",'"\x3e',this._buildCellContent(p,e,v,b,q,u),"\x3c/td\x3e")}c.push("\x3c/tr\x3e\x3c/table\x3e");return c.join("")},_buildCellContent:function(a,b,d,e,c,f){var g="";f=void 0===f&&d?d.data():f;c||(d=a.decorator?a.decorator(f,b,e,d):f,g=this._wrapCellData(d,b,a.id));return(""===g||null===g||void 0===g)&&(8>w("ie")||this.arg("stuffEmptyCell"))?"\x26nbsp;":g},_wrapCellData:function(a,
b,d){var e=[];this.collectCellWrapper(e,b,d);var c=e.length-1;for(0<c&&e.sort(function(a,b){return(a.priority||0)-(b.priority||0)});0<=c;--c)a=e[c].wrap(a,b,d);return a},_onMouseEvent:function(a,b){var d=this.grid,e="onCell"+a,c="onRow"+a;if(d._isConnected(e)||d._isConnected(c))if(this._decorateEvent(b),b.rowId){if(b.columnId)d[e](b);d[c](b)}},_decorateEvent:function(a){r.forEach("rowId columnId rowIndex visualIndex columnIndex parentId cellNode".split(" "),function(b){b in a&&delete a[b]});for(var b=
a.target||a.originalTarget,d=this.grid,e;b&&b!=d.bodyNode;b=b.parentNode){e=b.tagName&&b.tagName.toLowerCase();if("td"==e&&n.contains(b,"gridxCell")&&b.parentNode.parentNode.parentNode.parentNode.parentNode===d.bodyNode){var c=d._columnsById[b.getAttribute("colid")];a.cellNode=b;a.columnId=c.id;a.columnIndex=c.index}if("div"==e&&n.contains(b,"gridxRow")&&b.parentNode===d.bodyNode){a.rowId=b.getAttribute("rowid");a.parentId=b.getAttribute("parentid");a.rowIndex=parseInt(b.getAttribute("rowindex"),
10);a.visualIndex=parseInt(b.getAttribute("visualindex"),10);break}}},_onDelete:function(a,b,d){d&&1<d.length&&this.lazyRefresh()},_onSet:function(a,b,d,e){var c=this;if(c.autoUpdate&&d){var f=c.grid,g=f.row(a,1),l=g&&g.node();if(l){var k=d.data,h=e.data;d=f._columns;e=c.arg("renderWholeRowOnSet");var m=c.arg("compareOnSet");e?(l.innerHTML=c._buildCells(g,g.visualIndex()),c.onAfterRow(g),c.onSet(g),c.onRender(b,1)):r.forEach(d,function(b){if(!m(k[b.id],h[b.id])){var d=f.tree&&f.tree.isPaddingCell(a,
b.id),e=g.cell(b.id,1);if("auto"===(b.textDir||f.textDir)){var l=f.getTextDir(b.id,e.node().innerHTML);l&&(e.node().style.direction=l)}e.node().innerHTML=c._buildCellContent(b,a,e,g.visualIndex(),d);c.onAfterCell(e)}})}}},_onRowMouseOver:function(a){var b=q("\x3e div.gridxRowOver",this.domNode)[0];a=this.getRowNode({rowId:a.rowId});b!=a&&(b&&n.remove(b,"gridxRowOver"),a&&n.add(a,"gridxRowOver"))},_isDescendantRowNode:function(a){return a.parentNode===this.grid.bodyNode},_isDescendantCellNode:function(a){return a.parentNode.parentNode.parentNode.parentNode.parentNode===
this.grid.bodyNode},_focusCellCol:0,_focusCellRow:0,_initFocus:function(){var a=this,b=a.grid,d=b.focus;d.registerArea({name:"body",priority:1,focusNode:a.domNode,scope:a,doFocus:a._doFocus,doBlur:a._blurCell,onFocus:a._onFocus,onBlur:a._blurCell});a.connect(b.mainNode,"onkeydown",function(e){if(d.arg("enabled")&&"body"==d.currentArea()){var c=b._isCtrlKey(e);if(e.keyCode==x.HOME&&!c)a._focusCellCol=0,a._focusCell(),d.stopEvent(e);else if(e.keyCode==x.END&&!c)a._focusCellCol=b._columns.length-1,a._focusCell(),
d.stopEvent(e);else if(!b.tree||!c){d._noBlur=1;var c={},f=b.isLeftToRight()?1:-1;c[x.LEFT_ARROW]=[0,-f,e];c[x.RIGHT_ARROW]=[0,f,e];c[x.UP_ARROW]=[-1,0,e];c[x.DOWN_ARROW]=[1,0,e];a._moveFocus.apply(a,c[e.keyCode]||[]);d._noBlur=0}}});a.aspect(b,"onCellClick",function(b){a._focusCellRow=b.visualIndex;a._focusCellCol=b.columnIndex});a.aspect(a,"onRender",function(b,c){var f=d.currentArea();d.arg("enabled")&&("body"==f?a._focusCellRow>=b&&a._focusCellRow<b+c&&a._focusCell():d.focusArea(f,1))});a.connect(b.emptyNode,
"onfocus",function(){d.focusArea("body")})},_doFocus:function(a){return this._focusCell(a)||this._focusCell(0,-1,-1)},_focusCell:function(a,b,d){var e=this.grid;e.focus.stopEvent(a);d=0<=d?d:this._focusCellCol;b=0<=b?b:this._focusCellRow;a=e._columns[d]?e._columns[d].id:void 0;var c=this.getCellNode({visualIndex:b,colId:a});if(c)this._blurCell(),n.add(c,"gridxCellFocus"),this._focusCellRow=b,this._focusCellCol=d,e.header._focusHeaderId=a,8>w("ie")?(b=e.bodyNode.scrollLeft,c.focus(),e.bodyNode.scrollLeft=
b):c.focus(),e.hScroller.scrollToColumn(a,c.parentNode.parentNode.parentNode.parentNode);else if(!e.rowCount())return e.emptyNode.focus(),!0;return c},_moveFocus:function(a,b,d){if(a||b){var e,c,f=this,g=f.grid,l=g._columns.length,k=g.view.visualCount,h=9>w("ie")?y.mixin({},d):d;g.focus.stopEvent(d);e=f._focusCellRow+a;e=0>e?0:e>=k?k-1:e;c=f._focusCellCol+b;c=0>c?0:c>=l?l-1:c;g.vScroller.scrollToRow(e).then(function(){f._focusCell(0,e,c);f.onMoveToCell(e,c,h)})}},_nextCell:function(a,b,d,e){var c=
new v,f=this.grid,g=f._columns.length,l=f.view.visualCount;do if(b+=d,0>b||b>=g)a+=d,b=0>b?g-1:0,0>a?(a=l-1,b=g-1):a>=l&&(b=a=0);while(!e(a,b));f.vScroller.scrollToRow(a).then(function(){f.hScroller.scrollToColumn(f._columns[b].id);c.callback({r:a,c:b})});return c},_blurCell:function(){return!!q(".gridxCellFocus",this.domNode).removeClass("gridxCellFocus")},_onFocus:function(a){var b=this.domNode,d=q(a.target).closest(".gridxCell",b);return d[0]&&this._isDescendantCellNode(d[0])?(a=this.grid._columnsById[d[0].getAttribute("colid")].index,
b=parseInt(d.closest(".gridxRow",b)[0].getAttribute("visualindex"),10),this._focusCell(0,b,a)):!1}})});
//@ sourceMappingURL=Body.js.map