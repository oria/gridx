//>>built
define("gridx/core/model/extensions/Modify","dojo/_base/declare dojo/_base/lang dojo/DeferredList dojo/_base/Deferred dojo/_base/array ../_Extension".split(" "),function(k,f,l,h,m,n){return k(n,{name:"modify",priority:19,constructor:function(a,b){this._globalOptList=[];this._globalOptIndex=-1;this._cellOptList={};this._lazyData={};this._lazyRawData={};this._cache=a._cache;this._mixinAPI("set","redo","undo","isChanged","getChanged","save","clearLazyData");a.onSetLazyData=function(){};a.onRedo=a.onUndo=
function(){}},byId:function(a){var b=this.inner._call("byId",arguments);if(!b)return b;b=f.mixin({},b);b.rawData=f.mixin({},b.rawData,this._lazyRawData[a]);b.data=f.mixin({},b.data,this._lazyData[a]);return b},byIndex:function(a,b){var c=this.inner._call("byIndex",arguments),d=this.inner._call("indexToId",arguments);if(!c)return c;c=f.mixin({},c);c.rawData=f.mixin({},c.rawData,this._lazyRawData[d]);c.data=f.mixin({},c.data,this._lazyData[d]);return c},set:function(a,b){var c={},d=this._globalOptList,
e=this._globalOptIndex;c.type=0;c.rowId=a;c.newData=b;c.oldData={};var g=this.byId(a).rawData,f;for(f in b)c.oldData[f]=g[f];d.splice(e+1,d.length-1-e,c);this._globalOptIndex++;c=this.byId(a);this._set(a,b);d=this.byId(a);this.onSet(a,e,d,c)},undo:function(){var a=this._globalOptList[this._globalOptIndex];return a?(this._globalOptIndex--,0===a.type&&this._onUndo(a.rowId,a.oldData,a.newData),!0):!1},redo:function(){var a=this._globalOptList[this._globalOptIndex+1];return a?(this._globalOptIndex++,
0===a.type&&this._onRedo(a.rowId,a.newData,a.oldData),!0):!1},clearLazyData:function(){for(this.getChanged();0<=this._globalOptIndex;)this.undo();this._globalOptList=[];this._lazyRawData={};this._lazyData={}},save:function(){var a=this,b=a.getChanged(),c=[],d,e=new h;b.length?(m.forEach(b,function(b){b=a._saveRow(b);c.push(b)}),d=new l(c),d.then(function(){a._globalOptList=[];a._globalOptIndex=-1;a._lazyRawData={};a._lazyData={};a.onSave(d);e.callback()},function(){e.errback()})):e.callback();return e},
isChanged:function(a,b){var c=this.inner._call("byId",[a]),d=this._lazyRawData[a];if(b){if(d)return void 0!==d[b]?d[b]!==c.rawData[b]:!1}else if(d)for(var e in d)if(d[e]!==c.rawData[e])return!0;return!1},getChanged:function(){var a=[],b;for(b in this._lazyRawData)this.isChanged(b)&&a.push(b);return a},onSave:function(a){},onUndo:function(a,b,c){},onRedo:function(a,b,c){},_onSet:function(){this._globalOptList=[];this._globalOptIndex=-1;this.onSet.apply(this,arguments)},_onUndo:function(a,b,c){var d=
this._cache.idToIndex(a),e=this.byId(a);this._set(a,b);var f=this.byId(a);this.onSet(a,d,f,e);this.onUndo(a,b,c)},_onRedo:function(a,b,c){var d=this._cache.idToIndex(a),e=this.byId(a);this._set(a,b);var f=this.byId(a);this.onSet(a,d,f,e);this.onRedo(a,b,c)},_set:function(a,b){var c=this.inner._call("byId",[a]),d={};this._lazyRawData[a]?f.mixin(this._lazyRawData[a],b):this._lazyRawData[a]=f.mixin({},b);var e=this._cache.columns,c=f.mixin({},c.rawData,this._lazyRawData[a]),g;for(g in e)d[g]=e[g].formatter?
e[g].formatter(c):c[e[g].field||g];this._lazyData[a]=d},_saveRow:function(a){var b=this.model.store,c=this.byId(a).item;a=this._lazyRawData[a];var d;if(b.setValue){d=new h;try{for(var e in a)b.setValue(c,e,a[e]);b.save({onComplete:f.hitch(d,d.callback),onError:f.hitch(d,d.errback)})}catch(g){d.errback(g)}}return d||h.when(b.put(f.mixin({},c,a)))}})});
//@ sourceMappingURL=Modify.js.map