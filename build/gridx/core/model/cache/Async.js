//>>built
define("gridx/core/model/cache/Async","dojo/_base/declare dojo/_base/array dojo/_base/lang dojo/_base/Deferred dojo/DeferredList ./Sync".split(" "),function(t,m,n,q,r,u){function v(b,c,e,f){var a,d,g,h=c.range,k=b.store.getChildren;c.pids={};c.pids[b.layerId()]=c.range;if(k)for(a=h.length-1;0<=a;--a)d=h[a],g=d.parentId,b.model.isId(g)||(g=b.layerId()),b.model.isId(g)&&(c.id.push(g),c.pids[g]=c.pids[g]||[],c.pids[g].push(d),h.splice(a,1));a=p(b,c.id);var l=[];a.length?(m.forEach(a,function(a){var c=
b.idToIndex(a);0<=c&&!b.treePath(a).pop()?h.push({start:c,count:1}):l.push(a)}),w(b,l,function(a){a.length&&k?x(b,a,function(a){a.length&&console.warn("Requested row ids are not found: ",a);e(c)},f):e(c)},f)):e(c)}function y(b,c,e,f){var a=[],d=[],g=function(a,b){0<b.count&&a<b.start+b.count&&(b.count=a-b.start);return b.start<a},h;for(h in c.pids){var k=b._size[h],l=c.pids[h]=z(b,A(b,h,d,B(b,h,C(c.pids[h]))));0<k&&(l=m.filter(l,n.partial(g,k)));for(k=0;k<l.length;++k)l[k].parentId=h;[].push.apply(a,
l)}c._req=d.length&&new r(d,0,1);b._requests.push(c);a.length?(new r(m.map(a,function(a){return b._storeFetch(a)}),0,1)).then(e,f):e(c)}function A(b,c,e,f){var a,d=b._requests;for(b=d.length-1;0<=b;--b)a=d[b],f=D(f,a.pids[c]),f._overlap&&0>m.indexOf(e,a._def)&&e.push(a._def);return f}function D(b,c){if(!c.length||!b.length)return b;var e=[],f=0,a,d=[];a=function(a,b){var c,d;for(c=a.length-1;0<=c;--c){d=a[c];var f=d.start,g=b;e[f]=e[f]||0;e[f]+=g;d.count&&(d=d.start+d.count,f=-b,e[d]=e[d]||0,e[d]+=
f)}};a(b,1);a(c,2);for(var g=0,h=e.length;g<h;++g)if(e[g])if(f+=e[g],1===f)d.push({start:g});else if(3===f&&(d._overlap=!0),(a=d[d.length-1])&&!a.count)a.count=g-a.start;return d}function C(b){for(var c=[],e,f,a,d,g,h;0<b.length;){g=a=b.pop();h=0;for(e=b.length-1;0<=e;--e){d=b[e];a.start<d.start&&(f=d,d=a,a=f);if(d.count)if(a.start<=d.start+d.count)a.count&&a.start+a.count>d.start+d.count?d.count=a.start+a.count-d.start:a.count||(d.count=null);else{a=g;continue}b[e]=d;h=1;break}h||c.push(g)}return c}
function z(b,c){var e=[],f,a,d=b.pageSize;for(c.sort(function(a,b){return a.start-b.start});c.length;){f=c.shift();if(c.length)if(a=c[0],a.count&&a.count+a.start-f.start<=d){a.count=a.count+a.start-f.start;a.start=f.start;continue}else if(!a.count&&a.start-f.start<d){a.start=f.start;continue}e.push(f)}1==e.length&&e[0].count<d&&(e[0].count=d);return e}function p(b,c){var e=b._cache;return m.filter(c,function(b){return!e[b]})}function B(b,c,e){var f,a,d,g,h,k=[],l=b._struct[c]||[],m=b._size[c];for(f=
e.length-1;0<=f;--f){d=e[f];g=d.count?d.start+d.count:l.length-1;h=1;for(a=d.start;a<g;++a){var s=l[a+1];!s||!b._cache[s]?(h?k.push({parentId:c,start:a,count:1}):++k[k.length-1].count,h=0):h=1}d.count||(h?(0>m||a<m)&&k.push({parentId:c,start:a}):delete k[k.length-1].count)}return k}function w(b,c,e,f){var a=b._struct[""],d=[],g,h;if(c.length){for(var k=1,l=a.length;k<l;++k)a[k]||(h?g.count++:(h=1,d.push(g={start:k-1,count:1})));d.push({start:2>a.length?0:a.length-2})}var m=function(a){a.length&&d.length?
b._storeFetch(d.shift()).then(function(){m(p(b,a))},f):e(a)};m(c)}function x(b,c,e,f){var a=b._struct,d=a[""].slice(1),g=function(c){if(c.length&&d.length){var k=d.shift();b._storeFetch({parentId:k}).then(function(){[].push.apply(d,a[k].slice(1));g(p(b,c))},f)}else e(c)};g(c)}var E=n.hitch;return t(u,{isAsync:!0,constructor:function(b,c){var e=parseInt(c.cacheSize,10),f=parseInt(c.pageSize,10);this.cacheSize=0<=e?e:-1;this.pageSize=0<f?f:100},when:function(b,c){var e=this,f=b._def=new q,a=E(f,f.errback),
d=function(b){e._requests.pop();a(b)};v(e,b,function(a){y(e,a,function(a){q.when(a._req,function(){var a;if(c)try{c()}catch(b){a=b}e._requests.shift();a?f.errback(a):f.callback()},d)},d)},a);return f},keep:function(b,c){var e=this._kept;this._cache[b]&&(this._struct[b]&&!e[b])&&(e[b]=1,++this._keptSize);e[b]&&(!this._lock[b]&&c)&&(this._lock[b]=1,++this._lockSize)},free:function(b,c){this.model.isId(b)?this._kept[b]&&(this._lock[b]?c&&(delete this._lock[b],--this._lockSize):(delete this._kept[b],
--this._keptSize)):(this._kept=n.clone(this._lock),this._keptSize=this._lockSize)},clear:function(){this._requests&&this._requests.length?this._clearLock=1:(this.inherited(arguments),this._requests=[],this._priority=[],this._kept={},this._lock={},this._lockSize=this._keptSize=0)},_init:function(){},_checkSize:function(){var b,c=this.cacheSize,e=this._priority;if(this._clearLock)this._clearLock=0,this.clear();else if(0<=c)for(c+=this._keptSize;e.length>c;)b=e.shift(),this._kept[b]?e.push(b):delete this._cache[b]}})});
//@ sourceMappingURL=Async.js.map