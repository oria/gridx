//>>built
define("gridx/core/model/cache/Sync",["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/_base/Deferred","../_Extension"],function(t,r,n,l,u){function v(a){for(var b=a._struct,c=b[""].slice(1),e,d=function(a){[].push.apply(c,b[a].slice(1))};c.length;)e=c.shift(),a._storeFetch({parentId:e}).then(n.partial(d,e))}var w=n.hitch,s=n.mixin,p=r.indexOf;return t(u,{constructor:function(a,b){this.setStore(b.store);this.columns=n.mixin({},b.columnsById||b._columnsById);this._mixinAPI("byIndex",
"byId","indexToId","idToIndex","size","treePath","rootId","parentId","hasChildren","children","keep","free","layerId","setLayer","layerUp")},destroy:function(){this.inherited(arguments);this._layer="";this.clear()},setStore:function(a){var b=this,c=a.fetch;b.destroy();b._cnnts=[];b.store=a;!c&&a.notify?b.aspect(a,"notify",function(a,c){void 0===a?b._onDelete(c):void 0===c?b._onNew(a):b._onSet(a)}):(b.aspect(a,c?"onSet":"put","_onSet"),b.aspect(a,c?"onNew":"add","_onNew"),b.aspect(a,c?"onDelete":"remove",
"_onDelete"))},when:function(a,b){var c=new l;try{b&&b(),c.callback()}catch(e){c.errback(e)}return c},clear:function(){this._filled=0;this._priority=[];this._struct={};this._cache={};this._size={};this._struct[""]=[];this._size[""]=-1;this.totalSize=void 0},layerId:function(){return this._layer},setLayer:function(a){this._layer=a;this.model._msg("storeChange");this.model._onSizeChange()},layerUp:function(){var a=this.parentId(this._layer);this.setLayer(a)},byIndex:function(a,b){this._init();return this._cache[this.indexToId(a,
b)]},byId:function(a){this._init();return this._cache[a]},indexToId:function(a,b){this._init();var c=this._struct[this.model.isId(b)?b:this.layerId()];return"number"==typeof a&&0<=a?c&&c[a+1]:void 0},idToIndex:function(a){this._init();var b=this._struct;a=p(b[b[a]&&b[a][0]]||[],a);return 0<a?a-1:-1},treePath:function(a){this._init();for(var b=this._struct,c=[];void 0!==a;)c.unshift(a),a=b[a]&&b[a][0];""!==c[0]?c=[]:c.pop();return c},rootId:function(a){var b=this.treePath(a);return 1<b.length?b[1]:
!b.length?null:a},parentId:function(a){return this.treePath(a).pop()},hasChildren:function(a){var b=this.store,c;this._init();c=this.byId(a);return b.hasChildren&&b.hasChildren(a,c&&c.item)&&b.getChildren},children:function(a){this._init();a=this.model.isId(a)?a:"";for(var b=this._size[a],c=[],e=0;e<b;++e)c.push(this.indexToId(e,a));return c},size:function(a){this._init();a=this._size[this.model.isId(a)?a:this.layerId()];return 0<=a?a:-1},keep:function(){},free:function(){},onBeforeFetch:function(){},
onAfterFetch:function(){},onLoadRow:function(){},onSetColumns:function(a){var b,c,e,d;this.columns=n.mixin({},a);for(b in this._cache)for(e in c=this._cache[b],a)d=a[e],c.data[e]=this._formatCell(c.rawData,b,d.id)},_init:function(){this._filled||(this._storeFetch({start:0}),this.store.getChildren&&v(this),this.model._onSizeChange())},_itemToObject:function(a){var b=this.store,c={};return b.fetch?(r.forEach(b.getAttributes(a),function(e){c[e]=b.getValue(a,e)}),c):a},_formatCell:function(a,b,c){var e=
this.columns[c];return e.formatter?e.formatter(a,b):a[e.field||c]},_formatRow:function(a,b){var c=this.columns,e={},d;for(d in c)e[d]=this._formatCell(a,b,d);return e},_addRow:function(a,b,c,e,d){var f=this._struct,h=this._priority;d=this.model.isId(d)?d:"";var k=f[d];if(!k)throw Error("Fatal error of _Cache._addRow: parent item "+d+" of "+a+" is not loaded");var g=k[b+1];this.model.isId(g)&&g!==a&&console.error("Error of _Cache._addRow: different row id "+a+" and "+k[b+1]+" for same row index "+
b);k[b+1]=a;f[a]=f[a]||[d];""===d&&(b=p(h,a),0<=b&&h.splice(b,1),h.push(a));this._cache[a]={data:this._formatRow(c,a),rawData:c,item:e};this.onLoadRow(a)},_storeFetch:function(a,b){function c(a){d._size[k]=parseInt(a,10)}function e(b){if(b.ioArgs&&b.ioArgs.xhr){var c=m.ioArgs.xhr.getResponseHeader("Content-Range");c&&(c=c.match(/(.+)\//))?d.totalSize=+c[1]:d.totalSize=void 0}try{for(var e=a.start||0,c=0,g;g=b[c];++c)d._addRow(f.getIdentity(g),e+c,d._itemToObject(g),g,k);h.callback()}catch(l){h.errback(l)}}
var d=this,f=d.store,h=new l,k=d.model.isId(a.parentId)?a.parentId:"",g=s({},d.options||{},a),q=w(h,h.errback),m;d._filled=1;d.onBeforeFetch(g);""===k?f.fetch?f.fetch(s(g,{onBegin:c,onComplete:e,onError:q})):(m=f.query(g.query||{},g),l.when(m.total,c),l.when(m,e,q)):d.hasChildren(k)?(m=f.getChildren(d.byId(k).item,g),"total"in m?l.when(m.total,c):l.when(m,function(a){c(a.length)}),l.when(m,e,q)):h.callback();h.then(function(){d.onAfterFetch()});return h},_onSet:function(a){var b=this.store.getIdentity(a),
c=this.idToIndex(b),e=this.treePath(b),d=this._cache[b];e.length&&this._addRow(b,c,this._itemToObject(a),a,e.pop());this.onSet(b,c,this._cache[b],d)},_onNew:function(a,b){var c=this.store,e=this._itemToObject(a),d=b&&b[c.fetch?"item":"parent"];d&&c.getIdentity(d);var c=c.getIdentity(a),f=this._size[""];this.clear();this.onNew(c,0,{data:this._formatRow(e,c),rawData:e,item:a});!d&&0<=f&&(this._size[""]=f+1,0<=this.totalSize&&(this.totalSize=f+1),this.model._onSizeChange())},_onDelete:function(a){var b=
this.store,c=this._struct;a=b.fetch?b.getIdentity(a):a;b=this.treePath(a);if(b.length){var e,d,f,h=[a],k=b[b.length-1],g=this._size,l=g[""],m=p(c[k],a);c[k].splice(m,1);--g[k];for(d=0;d<h.length;++d)if(e=c[h[d]])for(f=e.length-1;0<f;--f)h.push(e[f]);for(d=h.length-1;0<=d;--d)f=h[d],delete this._cache[f],delete c[f],delete g[f],this.onDelete(f);d=p(this._priority,a);0<=d&&this._priority.splice(d,1);this.onDelete(a,m-1,b);!k&&0<=l&&(g[""]=l-1,0<=this.totalSize&&(this.totalSize=l-1),this.model._onSizeChange())}else this.clear(),
this.onDelete(a)}})});
//@ sourceMappingURL=Sync.js.map